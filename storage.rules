rules_version = '2';

// Firebase Storage Security Rules for DMO Press Release Platform
service firebase.storage {
  match /b/{bucket}/o {

    // Organization-based access control for release images
    // Verifies the user has a profile document in the org (same pattern as Firestore rules)
    match /orgs/{orgId}/releases/{releaseId}/{fileName} {
      // Helper: check user belongs to this org by reading their Firestore user doc
      function isOrgMember() {
        return request.auth != null
          && firestore.exists(/databases/(default)/documents/orgs/$(orgId)/users/$(request.auth.uid));
      }

      // Allow org members to read images
      allow read: if isOrgMember();

      // Allow org members to write images with validation
      allow write: if isOrgMember() &&
                      request.resource.size < 10 * 1024 * 1024 &&
                      request.resource.contentType.matches('image/(jpeg|png|webp|gif)');

      // Allow org members to delete images
      allow delete: if isOrgMember();
    }

    // Organization-based access control for partner submission images
    match /orgs/{orgId}/submissions/{submissionId}/{fileName} {
      function isOrgMember() {
        return request.auth != null
          && firestore.exists(/databases/(default)/documents/orgs/$(orgId)/users/$(request.auth.uid));
      }

      // Any org member (including partners) can read submission images
      allow read: if isOrgMember();

      // Any org member can write images with same validation as releases
      allow write: if isOrgMember() &&
                      request.resource.size < 10 * 1024 * 1024 &&
                      request.resource.contentType.matches('image/(jpeg|png|webp|gif)');

      // Allow org members to delete images
      allow delete: if isOrgMember();
    }

    // Deny all other access by default
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
